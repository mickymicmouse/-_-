# 8. SQL 응용

### SQL-DDL

* SQL 지원 데이터 타입
  * 정수 - INTEGER, SMALLINT
  * 실수 - FLOAT, REAL, DOUBLE PRECISION
  * 형식화된 숫자 - DEC(I,J) # I: 전체 자릿수, J: 소수부 자릿수
  * 고정 길이 문자 - CHAR(n), CHARACTER(n)
  * 가변 길이 문자 - VARCHAR(n), CHARACTER VARYING(n)
  * 고정 길이 비트열 - BIT(n)
  * 가변 길이 비트열 - VARBIT(n)
  * 날짜 - DATE
  * 시간 - TIME

* CREATE SCHEMA

  ```sql
  CREATE SCHEMA 스키마명 AUTHORIZATION 사용자_ID;
  
  CREATE SCHEMA 대학교 AUTHORIZATION 홍길동;
  ```

* CREATE DOMAIN

  ```sql
  CREATE DOMAIN 도메인명 [AS] 데이터_타입
  	[DEFAULT 기본값]
  	[CONSTRAINT 제약조건명 CHECK (범위값)];
  
  CREATE DOMAIN SEX CHAR(1)
  	DEFAULT '남'
  	CONSTRAINT VALID-SEX CHECK(VALUE IN ('남','여'))];
  ```

* CREATE TABLE

  ```sql
  CREATE TABLE 테이블명
  	(속성명 데이터_타입 [DEFAULT 기본값][NOT NULL],...
       [, PRIMARY_KEY(기본키_속성명,...)]
       [, UNIQUE(대체키_속성명,...)]
       [, FOREIGN KEY(외래키_속성명,...)]
       		REFERENCES 참조테이블(키본키_속성명,...)
       		[ON DELETE 옵션]
       		[ON UPDATE 옵션]
       [, CONSTRAINT 제약조건명][CHECK (조건식)]);
  
  CREATE TABLE 학생
  	(이름 VARCHAR(15) NOT NULL,
      학번 CHAR(8),
      전공 CHAR(5),
      성별 SEX,
      생년월일 DATE,
      PRIMARY KEY(학번),
      FOREIGN KEY(전공) REFERENCES 학과(학과코드)
      	ON DELETE SET NULL
      	ON UPDATE CASCADE,
      CONSTRAINT 생년월일제약 CHECK(생년월일>='1980-01-01'));
  ```

  * 참조 무결성의 CASCADE 법칙
    * 연관된 데이터를 삭제할 경우 다른 테이블의 데이터도 삭제 되는 것
  * ON DELETE[옵션] , ON UPDATE [옵션]
    * NO ACTION
    * CASCADE
    * SET NULL
    * SET DEFAULT

* 다른 테이블을 이용한 정의

  ```sql
  CREATE TABLE 신규 테이블명 AS SELECT 속성명[, 속성명,...] FROM 기존 테이블명;
  
  CREATE TABLE 재학생 AS SELECT 학번, 이름, 학년 FROM 학생;
  ```

* CREATE VIEW

  ```sql
  CREATE VIEW 뷰명(속성명 [,속성명,...]) AS SELECT문;
  
  CREATE VIEW 안산고객(성명, 전화번호) AS 
  SELECT 성명, 전화번호
  FROM 고객
  WHERE 주소='안산시';
  ```

* CREATE INDEX 

  ```sql
  CREATE [UNIQUE] INDEX 인덱스명
  ON 테이블명(속성명 [ASC | DESC] [, 속성명 [ASC | DESC]])
  [CLUSTER];
  
  CREATE UNIQUE INDEX 고객번호_IDX
  ON 고객(고객번호 DESC);
  ```

* ALTER TABLE

  ```sql
  ALTER TABLE 테이블명 ADD 속성명 데이터_타입 [DEFAULT '기본값'];
  ALTER TABLE 테이블명 ALTER 속성명 [SET DEFAULT '기본값'];
  ALTER TABLE 테이블명 DROP COLUMN 속성명 [CASCADE];
  
  ALTER TABLE 학생 ADD 학년 VARCHAR(3);
  ALTER TABLE 학생 ALTER 학번 VARCHAR(10) NOT NULL;
  ```

* DROP

  ```sql
  DROP SCHEMA 스키마명 [CASCADE | RESTRICTED];
  DROP DOMAIN 도메인명 [CASCADE | RESTRICTED];
  DROP TABLE 테이블명 [CASCADE | RESTRICTED];
  DROP VIEW 뷰명 [CASCADE | RESTRICTED];
  DROP INDEX 인덱스명 [CASCADE | RESTRICTED];
  DROP CONSTRAINT 제약조건명;
  
  DROP TABLE 학생 CASCADE;
  ```

* 문제

  ```sql
  문제 1.
  CREATE TABLE patient(
  name CHAR(5) PRIMARY KEY, name CHAR(10), sex CHAR(1), phone CHAR(20),
  CONSTRAINT sex_ck CHECK VALUE IN ('f','m'),
  CONSTRAINT id_fk FOREIGN KEY(id) REFERENCES doctor(doc_id));
  문제 2.
  CREATE TABLE instructor(
  id CHAR(5) PRIMARY KEY, name CHAR(15) NOT NULL, dept CHAR(15),
  FOREIGN KEY(dept) REFERENCES DEPARTMENT(dept)
  ON DELETE SET NULL
  ON UPDATE CASCADE);
  문제 3.
  ALTER TABLE patient ADD job CHAR(20);
  문제 4.
  CREATE VIEW CC(ccid, ccname, instname) AS
  SELECT Course.id, Course.name, Instructor.name
  FROM Course, Instructor
  WHERE Course.instructor == Instructor.id;
  문제 5.
  CREATE UNIQUE INDEX Stud_idx
  ON Student(ssn ASC);
  문제 8.
  CREATE INDEX 직원_name
  ON 직원(이름);
  문제 
  ```

  

### SQL-DCL

* GRANT / REVOKE

  ```sql
  GRANT 사용자등급 TO 사용자_ID_리스트 [IDENTIFIED BY 암호];
  REVOKE 사용자등급 FROM 사용자_ID_리스트
  
  - WITH GRANT OPTION : 부여받은 권한을 다른 사용자에게 부여할 수 있는 권한을 부여
  - GRANT OPTION FOR [옵션 종류]: 부여한 권한 [옵션종류]를 취소함
  
  GRANT RESOURCE TO NAVI;
  GRANT CONNECT TO STAR;
  GRANT ALL ON 고객 TO NAVI WITH GRANT OPTION;
  REVOKE GRANT OPTION FOR UPDATE ON 고객 FROM STAR;
  ```

* COMMIT

  * 데이터 베이스에 반영하는 것

* ROLLBACK

  * COMMIT 되지 않은 변경된 모든 내용을 취소

* SAVEPOINT

  * ROLLBACK 할 위치를 지정하는 방법

  ```sql
  DELETE * FROM 사원 WHERE 사원번호 = 40;
  COMMIT;
  
  DELETE * FROM 사원 WHERE 사원번호 = 30;
  SAVEPOINT S1;
  # 사원30이 삭제된 상태를 저장
  
  DELETE * FROM 사원 WHERE 사원번호 = 20;
  SAVEPOINT S2;
  # 사원 20이 삭제된 상태를 저장
  
  DELETE * FROM 사원 WHERE 사원번호 = 10;
  # 사원 10 삭제
  
  ROLLBACK TO S2;
  # 사원 10이 있는 상태로 되돌림
  
  ROLLBACK TO S1;
  # 사원 20이 있는 상태로 되돌림
  
  ROLLBACK;
  # 커밋 이후 상태로 되돌림. 즉, 사원 30이 있는 상태로 되돌림
  ```

* 문제

  ```sql
  문제 1.
  GRANT ALL ON 학생 TO 김하늘;
  문제 2.
  GRANT DELETE ON 강좌 TO 김하늘 WITH GRANT OPTION;
  문제 3.
  REVOKE SELECT, DELETE, UPDATE ON 교수 FROM 임꺽정;
  문제 4.
  REVOKE UPDATE ON 수강 FROM 임꺽정 CASCADE;
  문제 6.
  ROLLBACK TO P1;
  ```

  

### SQL-DML





### DML-SELECT-1





### DML-SELECT-2





### 프로시저





### 트리거





### 사용자 정의 함수





### 제어문





### 커서

